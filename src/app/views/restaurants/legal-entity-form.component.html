<div class="page-container">
  <div class="page-header">
    <div class="header-left">
      <button class="btn-back" (click)="cancel()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <h1 class="page-title">
        {{ isEditMode ? 'Редактировать юридическое лицо' : 'Создать юридическое лицо' }}
      </h1>
    </div>
    <div class="header-actions">
      <button
        class="btn-primary"
        (click)="saveEntity()"
        [disabled]="isSaving || !isFormValid"
        [title]="validationTooltip">
        {{ isEditMode ? 'Сохранить' : 'Создать' }}
      </button>
    </div>
  </div>

  <div class="page-content">
    <div class="form-card">
      <h2 class="section-title">Основная информация</h2>

      <h3 class="subsection-title">Общие сведения</h3>

      <div class="form-group">
        <label class="form-label">Название*</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="form.name"
          placeholder="Введите название"
          required>
      </div>

      <div class="form-group">
        <label class="form-label">Описание</label>
        <textarea
          class="form-textarea"
          [(ngModel)]="form.description"
          rows="2"
          placeholder="Введите описание организации"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Группа</label>
        <div class="group-selector-wrapper">
          <select
            class="form-input"
            [(ngModel)]="form.group_id">
            <option [value]="undefined">Без группы</option>
            <option *ngFor="let group of groups" [value]="group.id">
              {{ group.name }}
            </option>
          </select>
          <button
            type="button"
            class="btn-add-group"
            (click)="openCreateGroupModal()"
            title="Создать новую группу">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <h3 class="subsection-title">Реквизиты</h3>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ИНН</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="form.inn"
            placeholder="Введите ИНН"
            maxlength="12">
        </div>

        <div class="form-group">
          <label class="form-label">КПП</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="form.kpp"
            placeholder="Введите КПП"
            maxlength="9">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ОКПО</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="form.okpo"
            placeholder="Введите ОКПО"
            maxlength="10">
        </div>

        <div class="form-group">
          <label class="form-label">ОКПД</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="form.okpd"
            placeholder="Введите ОКПД"
            maxlength="10">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ОГРН</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="form.ogrn"
          placeholder="Введите ОГРН"
          maxlength="13">
      </div>

      <h3 class="subsection-title">Юридический адрес</h3>

      <div class="form-group">
        <label class="form-label">Название улицы и дом*</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="form.legal_address_street"
          placeholder="Например: ул. Ленина, д. 10, кв. 5"
          required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Город/населенный пункт*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="form.legal_address_city"
            placeholder="Введите город"
            required>
        </div>

        <div class="form-group">
          <label class="form-label">Область/регион*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="form.legal_address_region"
            placeholder="Введите регион"
            required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Страна*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="form.legal_address_country"
            placeholder="Введите страну"
            required>
        </div>

        <div class="form-group">
          <label class="form-label">Почтовый код</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="form.legal_address_postal_code"
            placeholder="Введите почтовый код">
        </div>
      </div>

      <h3 class="subsection-title">Настройки франчайзинга</h3>

      <div class="form-group">
        <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input
            type="checkbox"
            [(ngModel)]="form.is_franchise"
            style="width: 18px; height: 18px; cursor: pointer;">
          Франчайзи
        </label>
      </div>

      <div class="form-group" *ngIf="form.is_franchise">
        <label class="form-label">Процент роялти (%)</label>
        <input
          type="number"
          class="form-input"
          [(ngModel)]="form.royalty_percent"
          placeholder="Введите процент роялти"
          min="0"
          max="100"
          step="0.1">
      </div>

      <h3 class="subsection-title">Контактная информация</h3>

      <div class="form-group">
        <label class="form-label">Телефон</label>
        <input
          type="tel"
          class="form-input"
          [(ngModel)]="form.phone"
          placeholder="+7 (___) ___-__-__">
      </div>

      <div class="form-group">
        <label class="form-label">Руководитель (ФИО)</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="form.director_name"
          placeholder="Введите ФИО руководителя">
      </div>

      <div class="form-group">
        <label class="form-label">Бухгалтер (ФИО)</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="form.accountant_name"
          placeholder="Введите ФИО бухгалтера">
      </div>

      <div class="form-group">
        <label class="form-label">Технолог (ФИО)</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="form.technologist_name"
          placeholder="Введите ФИО технолога">
      </div>

      <div class="form-group">
        <label class="form-label">Зав. производством (ФИО)</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="form.production_manager_name"
          placeholder="Введите ФИО зав. производством">
      </div>

      <h3 class="subsection-title">Банковские реквизиты</h3>

      <div class="form-group">
        <label class="form-label">Расчетный счет*</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="bankAccount.account_number"
          placeholder="Введите расчетный счет"
          maxlength="20"
          required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">БИК</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="bankAccount.bik"
            placeholder="Введите БИК"
            maxlength="9">
        </div>

        <div class="form-group">
          <label class="form-label">Корреспондентский счет</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="bankAccount.correspondent_account"
            placeholder="Введите корр. счет"
            maxlength="20">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Название банка</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="bankAccount.bank_name"
            placeholder="Введите название банка">
        </div>

        <div class="form-group">
          <label class="form-label">Город банка</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="bankAccount.bank_city"
            placeholder="Введите город банка">
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showGroupModal" (click)="closeGroupModal()"></div>
  <div class="group-modal" *ngIf="showGroupModal">
    <div class="modal-header">
      <h3 class="modal-title">Создать группу</h3>
      <button class="modal-close" (click)="closeGroupModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">Название группы*</label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="newGroupForm.name"
          placeholder="Например: Центральный регион"
          autofocus>
      </div>
      <div class="form-group">
        <label class="form-label">Описание</label>
        <textarea
          class="form-textarea"
          [(ngModel)]="newGroupForm.description"
          placeholder="Краткое описание группы"
          rows="3"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeGroupModal()">Отмена</button>
      <button
        class="btn-save"
        (click)="saveNewGroup()"
        [disabled]="!newGroupForm.name.trim() || isSavingGroup">
        {{ isSavingGroup ? 'Сохранение...' : 'Создать' }}
      </button>
    </div>
  </div>
</div>
