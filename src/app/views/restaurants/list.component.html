<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">Список ресторанов</h1>
    <div class="header-actions">
      <button class="btn-icon" (click)="onSearch()" title="Поиск">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="create-menu-container">
        <button class="btn-primary" (click)="onCreate()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div class="create-menu" *ngIf="showCreateMenu">
          <button class="create-menu-item" (click)="onCreateLegalEntity()">
            Создать юридическое лицо
          </button>
          <button class="create-menu-item" (click)="onCreateRestaurant()">
            Создать ресторан
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="page-content">
    <div class="table-container">
      <table class="data-table hierarchy-table">
        <thead>
          <tr>
            <th class="col-number">№</th>
            <th>
              <div class="th-content">
                <span>Название</span>
              </div>
            </th>
            <th>
              <div class="th-content">
                <span>Тип</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of hierarchyItems; let i = index"
              class="data-row"
              [class.hierarchy-level-0]="item.level === 0"
              [class.hierarchy-level-1]="item.level === 1"
              [class.hierarchy-level-2]="item.level === 2"
              [class.group-row]="item.type === 'group'"
              [class.legal-entity-row]="item.type === 'legalEntity'"
              [class.restaurant-row]="item.type === 'restaurant'">
            <td class="col-number">{{ i + 1 }}</td>
            <td>
              <div class="hierarchy-cell" [style.padding-left.px]="item.level * 24">
                <button
                  *ngIf="item.type === 'group'"
                  class="expand-btn"
                  (click)="toggleGroup(item.id)">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" [class.expanded]="item.isExpanded">
                    <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button
                  *ngIf="item.type === 'legalEntity'"
                  class="expand-btn"
                  (click)="toggleLegalEntity(item.id)">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" [class.expanded]="item.isExpanded">
                    <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <span class="item-icon" *ngIf="item.type === 'group'">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M3 6C3 4.89543 3.89543 4 5 4H7C8.10457 4 9 4.89543 9 6V8C9 9.10457 8.10457 10 7 10H5C3.89543 10 3 9.10457 3 8V6Z" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M11 6C11 4.89543 11.8954 4 13 4H15C16.1046 4 17 4.89543 17 6V8C17 9.10457 16.1046 10 15 10H13C11.8954 10 11 9.10457 11 8V6Z" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M3 12C3 10.8954 3.89543 10 5 10H7C8.10457 10 9 10.8954 9 12V14C9 15.1046 8.10457 16 7 16H5C3.89543 16 3 15.1046 3 14V12Z" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M11 12C11 10.8954 11.8954 10 13 10H15C16.1046 10 17 10.8954 17 12V14C17 15.1046 16.1046 16 15 16H13C11.8954 16 11 15.1046 11 14V12Z" stroke="currentColor" stroke-width="1.5"/>
                  </svg>
                </span>
                <span class="item-icon" *ngIf="item.type === 'legalEntity'">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M3 18V8L10 3L17 8V18H12V13H8V18H3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                  </svg>
                </span>
                <span class="item-icon" *ngIf="item.type === 'restaurant'">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M3 8H17M6 4V8M10 4V8M14 4V8M4 8H16C16.5523 8 17 8.44772 17 9V17C17 17.5523 16.5523 18 16 18H4C3.44772 18 3 17.5523 3 17V9C3 8.44772 3.44772 8 4 8Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                  </svg>
                </span>
                <a
                  *ngIf="item.type !== 'group'"
                  href="#"
                  class="link"
                  (click)="item.type === 'legalEntity' ? onEditLegalEntity(item.data) : onEditRestaurant(item.data); $event.preventDefault()">
                  {{ item.name }}
                </a>
                <span *ngIf="item.type === 'group'" class="group-name">
                  {{ item.name }}
                </span>
                <span *ngIf="item.isDraft" class="draft-tag">
                  ЧЕРНОВИК
                </span>
                <span *ngIf="item.isFranchise" class="franchise-tag">
                  ФРАНЧАЙЗИ
                </span>
                <button
                  *ngIf="item.type === 'legalEntity'"
                  class="add-restaurant-btn"
                  (click)="onCreateRestaurant(); $event.stopPropagation()"
                  title="Добавить ресторан">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </td>
            <td>
              <span *ngIf="item.type === 'group'" class="type-badge type-group">Группа</span>
              <span *ngIf="item.type === 'legalEntity'" class="type-badge type-legal">Юридическое лицо</span>
              <span *ngIf="item.type === 'restaurant'" class="type-badge type-restaurant">Ресторан</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="sidebar-overlay" *ngIf="showSidebar || showLegalEntitySidebar" (click)="closeSidebar()"></div>

  <div class="sidebar" [class.open]="showSidebar" *ngIf="sidebarMode === 'restaurant'">
    <div class="sidebar-header">
      <div class="sidebar-title-section">
        <h2 class="sidebar-title">{{ restaurantForm.name }}</h2>
        <div class="sidebar-subtitle">Редактировать / Настройки</div>
      </div>
      <button class="sidebar-close" (click)="closeSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="sidebar-tabs">
      <button
        class="sidebar-tab"
        [class.active]="activeTab === 'general'"
        (click)="setActiveTab('general')">
        ОБЩИЕ
      </button>
      <button
        class="sidebar-tab"
        [class.active]="activeTab === 'hours'"
        (click)="setActiveTab('hours')">
        ЧАСЫ РАБОТЫ
      </button>
      <button
        class="sidebar-tab"
        [class.active]="activeTab === 'warehouse'"
        (click)="setActiveTab('warehouse')">
        СКЛАД
      </button>
      <button
        class="sidebar-tab"
        [class.active]="activeTab === 'terminals'"
        (click)="setActiveTab('terminals')">
        ТЕРМИНАЛЫ
      </button>
      <button
        class="sidebar-tab"
        [class.active]="activeTab === 'external'"
        (click)="setActiveTab('external')">
        ВНЕШНИЕ
      </button>
      <button class="sidebar-tab-arrow">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M7 5L12 10L7 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="sidebar-content" *ngIf="activeTab === 'general'">
      <div class="form-section">
        <div class="status-row">
          <div class="status-label">
            Статус подключения
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="info-icon">
              <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 7V11M8 5V5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="status-badge">Подключен</div>
          <div class="timezone-text">Часовой пояс: {{ restaurantForm.timezone }}</div>
        </div>

        <h3 class="section-title">Основная информация</h3>

        <div class="form-group">
          <label class="form-label">Название*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.name"
            placeholder="Название ресторана">
        </div>

        <div class="form-group">
          <label class="form-label">Описание</label>
          <textarea
            class="form-textarea"
            [(ngModel)]="restaurantForm.description"
            placeholder="Описание ресторана"
            rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Краткое название</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="restaurantForm.shortName"
              placeholder="Краткое название">
          </div>

          <div class="form-group">
            <label class="form-label">Код</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="restaurantForm.code"
              placeholder="Код">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">UID</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="restaurantForm.uid"
              placeholder="123-123-123"
              readonly>
          </div>

          <div class="form-group">
            <label class="form-label">КПП</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="restaurantForm.kpp"
              placeholder="КПП">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Категория 1</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.category1"
            placeholder="Категория 1">
        </div>

        <div class="form-group">
          <label class="form-label">Категория 2</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.category2"
            placeholder="Категория 2">
        </div>

        <div class="form-group">
          <label class="form-label">Категория 3</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.category3"
            placeholder="Категория 3">
        </div>

        <div class="form-group">
          <label class="form-label">Категория 4</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.category4"
            placeholder="Категория 4">
        </div>

        <div class="form-group">
          <label class="form-label">Категория 5</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.category5"
            placeholder="Категория 5">
        </div>

        <div class="form-group">
          <label class="form-label">
            E-mail*
            <span class="email-info-icon" title="На указанный email будут отправлены данные для входа в личный кабинет iiko web">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                <path d="M8 7V11M8 5V5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </span>
          </label>
          <input
            type="email"
            class="form-input"
            [class.error]="emailError"
            [(ngModel)]="restaurantForm.email"
            (blur)="validateEmail()"
            placeholder="email@example.com"
            required>
          <div class="field-hint" *ngIf="!emailError && restaurantForm.email">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="hint-icon">
              <path d="M2 3L8 8L14 3M2 3V13H14V3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            На этот адрес будут отправлены логин и пароль для входа в личный кабинет iiko web
          </div>
          <div class="field-error" *ngIf="emailError">{{ emailError }}</div>
        </div>

        <div class="form-group">
          <app-searchable-select
            [label]="'Шаблон ресторана'"
            [options]="templateOptions"
            [placeholder]="'Поиск...'"
            [(ngModel)]="restaurantForm.template"
            name="template">
          </app-searchable-select>
        </div>

        <div class="form-group">
          <app-searchable-select
            [label]="'Юридическое лицо*'"
            [options]="legalEntityOptions"
            [placeholder]="'Поиск...'"
            [(ngModel)]="restaurantForm.legalEntityId"
            name="legalEntity">
          </app-searchable-select>
        </div>

        <h3 class="section-title">Настройки</h3>

        <div class="form-checkbox-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              class="form-checkbox"
              [(ngModel)]="restaurantForm.isFranchise">
            <span>Франшизный ресторан</span>
          </label>
        </div>

        <div class="form-group" *ngIf="restaurantForm.isFranchise">
          <label class="form-label">Процент роялти</label>
          <input
            type="number"
            class="form-input"
            [(ngModel)]="restaurantForm.royaltyPercent"
            placeholder="0"
            min="0"
            max="100"
            step="0.01">
        </div>

        <h3 class="section-title">Фактический адрес</h3>

        <div class="form-group">
          <label class="form-label">Город / населенный пункт*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.city"
            placeholder="Город">
        </div>

        <div class="form-group">
          <label class="form-label">Область / регион*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.region"
            placeholder="Область">
        </div>

        <div class="form-group">
          <label class="form-label">Страна*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.country"
            placeholder="Страна">
        </div>

        <div class="form-group">
          <label class="form-label">Адрес ресторана - общий вид*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.address"
            placeholder="Адрес ресторана">
        </div>

        <div class="form-group">
          <label class="form-label">Комментарии к адресу</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="restaurantForm.addressComment"
            placeholder="Комментарии к адресу">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Координаты: Широта</label>
            <input
              type="number"
              class="form-input"
              [(ngModel)]="restaurantForm.latitude"
              placeholder="Широта"
              step="0.000001">
          </div>

          <div class="form-group">
            <label class="form-label">Координаты: Долгота</label>
            <input
              type="number"
              class="form-input"
              [(ngModel)]="restaurantForm.longitude"
              placeholder="Долгота"
              step="0.000001">
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="btn-cancel" (click)="closeSidebar()">Отмена</button>
      <button class="btn-save" (click)="onSave()">Сохранить</button>
    </div>
  </div>

  <div class="sidebar" [class.open]="showLegalEntitySidebar" *ngIf="sidebarMode === 'legalEntity'">
    <div class="sidebar-header">
      <div class="sidebar-title-section">
        <h2 class="sidebar-title">{{ legalEntityForm.name || 'Новое юридическое лицо' }}</h2>
        <div class="sidebar-subtitle">Редактировать / Настройки</div>
      </div>
      <button class="sidebar-close" (click)="closeSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="sidebar-content">
      <div class="form-section">
        <h3 class="section-title">Основная информация</h3>

        <div class="form-group">
          <label class="form-label">Название*</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="legalEntityForm.name"
            placeholder="Название юридического лица">
        </div>

        <div class="form-group">
          <label class="form-label">Описание</label>
          <textarea
            class="form-textarea"
            [(ngModel)]="legalEntityForm.description"
            placeholder="Описание"
            rows="3"></textarea>
        </div>

        <h3 class="section-title">Реквизиты</h3>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ИНН*</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="legalEntityForm.inn"
              placeholder="ИНН"
              maxlength="12">
          </div>

          <div class="form-group">
            <label class="form-label">КПП</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="legalEntityForm.kpp"
              placeholder="КПП"
              maxlength="9">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ОКПО</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="legalEntityForm.okpo"
              placeholder="ОКПО">
          </div>

          <div class="form-group">
            <label class="form-label">Регистрационный номер</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="legalEntityForm.registrationNumber"
              placeholder="Регистрационный номер">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ОГРН</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="legalEntityForm.ogrn"
            placeholder="ОГРН">
        </div>

        <div class="form-row">
          <div class="form-group">
            <app-searchable-select
              [label]="'ФИО руководителя'"
              [options]="employeeOptions"
              [placeholder]="'Поиск...'"
              [(ngModel)]="legalEntityForm.directorName"
              name="directorName">
            </app-searchable-select>
          </div>

          <div class="form-group">
            <label class="form-label">Должность руководителя</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="legalEntityForm.directorPosition"
              placeholder="Должность руководителя">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Юридический адрес</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="legalEntityForm.legalAddress"
            placeholder="Юридический адрес">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Телефон</label>
            <input
              type="tel"
              class="form-input"
              [(ngModel)]="legalEntityForm.phone"
              placeholder="+7 (___) ___-__-__">
          </div>

          <div class="form-group">
            <label class="form-label">E-mail</label>
            <input
              type="email"
              class="form-input"
              [(ngModel)]="legalEntityForm.email"
              placeholder="email@example.com">
          </div>
        </div>

        <h3 class="section-title">Банковские реквизиты</h3>

        <div class="form-group">
          <label class="form-label">Расчетный счет</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="legalEntityForm.bankAccount"
            placeholder="Расчетный счет"
            maxlength="20">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">БИК</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="legalEntityForm.bik"
              placeholder="БИК"
              maxlength="9">
          </div>

          <div class="form-group">
            <label class="form-label">Корреспондентский счет</label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="legalEntityForm.correspondentAccount"
              placeholder="Корреспондентский счет"
              maxlength="20">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Название банка</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="legalEntityForm.bankName"
            placeholder="Название банка">
        </div>

        <div class="form-group">
          <label class="form-label">Город банка</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="legalEntityForm.bankCity"
            placeholder="Город банка">
        </div>

        <h3 class="section-title">Ответственные лица</h3>

        <div class="form-group">
          <app-searchable-select
            [label]="'ФИО руководителя'"
            [options]="employeeOptions"
            [placeholder]="'Поиск...'"
            [(ngModel)]="legalEntityForm.directorName"
            name="directorNameModal">
          </app-searchable-select>
        </div>

        <div class="form-group">
          <app-searchable-select
            [label]="'ФИО бухгалтера'"
            [options]="employeeOptions"
            [placeholder]="'Поиск...'"
            [(ngModel)]="legalEntityForm.accountantName"
            name="accountantName">
          </app-searchable-select>
        </div>

        <div class="form-group">
          <app-searchable-select
            [label]="'ФИО главного технолога'"
            [options]="employeeOptions"
            [placeholder]="'Поиск...'"
            [(ngModel)]="legalEntityForm.chiefTechnologistName"
            name="chiefTechnologistName">
          </app-searchable-select>
        </div>

        <div class="form-group">
          <app-searchable-select
            [label]="'ФИО зав. производством'"
            [options]="employeeOptions"
            [placeholder]="'Поиск...'"
            [(ngModel)]="legalEntityForm.productionManagerName"
            name="productionManagerName">
          </app-searchable-select>
        </div>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="btn-cancel" (click)="closeSidebar()">Отмена</button>
      <button class="btn-save" (click)="onSave()">Сохранить</button>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showSuccessModal" (click)="closeSuccessModal()"></div>
  <div class="success-modal" *ngIf="showSuccessModal">
    <div class="modal-icon success">
      <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
        <circle cx="32" cy="32" r="28" stroke="#00C853" stroke-width="4"/>
        <path d="M20 32L28 40L44 24" stroke="#00C853" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <h3 class="modal-title">Ресторан успешно создан!</h3>
    <div class="modal-message">
      <p>Учетные данные для входа в личный кабинет iiko web были отправлены на адрес:</p>
      <p class="modal-email">{{ restaurantForm.email }}</p>
      <p class="modal-note">Письмо содержит логин и пароль для доступа к системе управления рестораном.</p>
    </div>
    <button class="btn-modal-close" (click)="closeSuccessModal()">Понятно</button>
  </div>
</div>
